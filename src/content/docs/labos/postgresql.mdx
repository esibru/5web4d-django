---
title: PostgreSQL
description: /
---
import { Card, Aside, FileTree, Steps, Tabs, TabItem, Code } from '@astrojs/starlight/components';

Et si nous changions le SGBD afin d'utiliser PostgreSQL ? 

## Installation

<Tabs>
<TabItem label="Postgres sur docker">

<Steps>

1. Ajouter un dockerfile avec le contenu suivant (adapt√© avec vos donn√©es).
   ``` text showLineNumbers=false title=Dockerfile
   FROM postgres:16
   
   ENV POSTGRES_USER=g12345
   ENV POSTGRES_PASSWORD=admin
   ENV POSTGRES_DB=mproject
   ```
1. Cr√©er une image

   ``` text showLineNumbers=false frame=none
   docker build -t mypostgres .
   ```

1. Cr√©er un conteneur

   ``` text showLineNumbers=false frame=none
   docker run --name mypostgres -p 5433:5432 -d mypostgres
   ```
   (`--name` permet de nommer le conteneur)

1. Installer `psycopg2`:
   ``` sh showLineNumbers=false frame="none"
   python -m pip install django psycopg2
   ```

</Steps>

</TabItem>

<TabItem label="Installation machine">

<Steps>
1. Installer [PostgreSQL](https://www.postgresql.org/)
2. Cr√©er une DB (par exemple `mproject`) : 
   ``` sql showLineNumbers=false frame="none" 
   CREATE DATABASE mproject;
   ```
3. Cr√©er un r√¥le (dans `psql`): 
   ``` sql showLineNumbers=false frame="none" 
   create role <le r√¥le> login password '<le mdp>';
   ```
4. Donner les droits n√©cessaires √† ce nouveau r√¥le (dans `psql`) : 
   ``` sql showLineNumbers=false frame="none"
   grant all privileges on database mproject to <le r√¥le>;
   ```
5. Installer `psycopg2`:
   ``` sh showLineNumbers=false frame="none"
   python -m pip install django psycopg2
   ```
6. Pour √©viter la manipulation de [sch√©ma](https://docs.postgresql.fr/10/ddl-schemas.html), nous vous sugg√©rons de d√©finir votre r√¥le comme propri√©taire de la base de donn√©e `mproject` :
   ``` sql showLineNumbers=false frame="none"
   alter database mproject owner to <role>;
   ```
7. Configurer l'utilisation de la base de donn√©es dans `settings.py`
</Steps>

</TabItem>
</Tabs>

``` python showLineNumbers=false title=mproject/settings.py del={1-4} ins={5-16}
  'default': {
      'ENGINE': 'django.db.backends.sqlite3',
      'NAME': BASE_DIR / 'db.sqlite3',
  },
  #'default': {
  #    'ENGINE': 'django.db.backends.sqlite3',
  #    'NAME': BASE_DIR / 'db.sqlite3',
  #},
  'default': {
      'ENGINE': 'django.db.backends.postgresql_psycopg2',
      'NAME': 'mproject',
      'USER': '<le r√¥le>',
      'PASSWORD': '<le mdp>',
      'HOST': 'localhost',
      'PORT': '5433',
  }
```

<Aside title="Migration" icon="seti:db">
Il ne reste qu'√† r√©aliser la migration, quelle commande allez-vous utiliser  ?
</Aside>

<Aside title="Docker - psql" icon="seti:docker">
Vous pouvez acc√©der au terminal interactif de postgres [psql](https://docs.postgresql.fr/13/app-psql.html) gr√¢ce √† la commande

   ``` bash showLineNumbers=false frame=none
   docker exec -it mypostgres psql -U g12345 -d mproject
   ```
Et d√®s lors,
* lister les tables existantes :
   ``` sql showLineNumbers=false frame=none
   \dt
   ```
* d√©crire une  table :
   ``` sql showLineNumbers=false frame=none
   \d developer_developer
   ```
  
* faire toutes les requ√™tes utiles (en n'oubliant pas le `;`)
   Ex : 
   ``` sql showLineNumbers=false frame=none
   SELECT * FROM developer_developer;
   ``` 
* ...
</Aside>

## Migrations

Lorsque nous sommes au d√©but du d√©veloppement d'un logiciel, nous pouvons √©chapper aux probl√®mes li√©s aux migrations. Nous allons cependant voir le minimum afin de g√©rer les quelques conflits que nous pourrions rencontrer. Si la gestion des migrations vous int√©resse, vous trouverez de quoi satisfaire votre curiosit√© [ici](https://docs.djangoproject.com/fr/4.1/topics/migrations/).

Imaginons que nous souhaitons ajouter un nouveau champ `username` √† notre mod√®le `Developer`.

```python showLineNumbers=false title=developer/models.py ins={4}
  class Developer(models.Model):
      first_name = models.CharField("first name", max_length=200)
      last_name = models.CharField(max_length=200)
      user_name = models.CharField(max_length=50)

      #...
```

Saisissez la commande `python manage.py makemigrations` qui va v√©rifier les changements et g√©n√©rer un nouveau fichier permettant la migration.

Vous devriez avoir ce message : 

``` sh showLineNumbers=false frame="none"
You are trying to add a non-nullable field 'user_name' to developer without a default; we can't do that (the database needs something to populate existing rows).
Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
 2) Quit, and let me add a default in models.py
Select an option: 
```

La raison est simple. Des donn√©es sont potentiellement pr√©sentes dans la base de donn√©es et nous ne pouvons pas supposer qu'il n'y en a pas (imaginez s'il y a plusieurs instances du site). Django vous demande donc ce que vous voulez faire pour le champ `username` puisque celui-ci s'ajoute aux enregistrements pr√©sents et que celui-ci est obligatoire.

La proc√©dure que nous allons vous soumettre est un peu radicale, mais nous sommes aux pr√©mices du d√©veloppement de notre projet. C'est donc satisfaisant comme cela !

<Steps>
1. R√©initialiser la base de donn√©es.
   * Si vous utilisez toujours SQLite, alors supprimez le fichier `db.sqlite3` (ou mieux, faite la configuration n√©cessaire √† l'utilisation de PostgreSQL).
   * Si vous utilisez PostgreSQL comme demand√©, nous allons plut√¥t d√©faire toutes les migrations r√©alis√©es. Lancez la commande : `$ python manage.py migrate developer zero`.

1. Supprimez les fichiers pr√©sents dans le dossier `migrations`. Ceux-ci ont g√©n√©ralement la forme : `000x_...`.
   <FileTree>
   - developer/
      - migrations/
         - 0001\_initial.py
         - ...
         - 000n\_initial.py
   </FileTree>

1. Relancez la proc√©dure compl√®te de migration
   1. `python manage.py makemigrations`
   1. `python manage.py migrate`

</Steps>

<Aside title="Exercice" icon="pencil">
Pour vous entra√Æner, supprimez le champ `user_name` que vous venez de cr√©er, cela va nous g√™ner par la suite et cela vous permet de vous entra√Æner avec la proc√©dure !
</Aside>

> üìÉ Il est √©galement possible de supprimer la base de donn√©e et d'en cr√©er une nouvelle. Si vous faites cela, pensez √† supprimer les fichiers de migration ! (‚ö†Ô∏è √Ä ne pas faire en production.)
