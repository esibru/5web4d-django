---
title: Gestion des utilisateur
description: /
---
import { Aside} from '@astrojs/starlight/components';

Nous allons maintenant modifier le modèle développeur afin que ceux-ci soient des utilisateurs.

Si vous vous documentez par vous-même, vous risquez de tomber sur l'ancienne approche qui consistait à réaliser un lien **OneToOne** qui était appelé `modèle de profil". Dans ce cours, nous allons voir la plus simple des deux techniques récentes.

En effet, il existe deux possibilités. Soit étendre le modèle `AbstractUser`, soit étendre le modèle `AbstractBaseUser`. Nous allons plutôt choisir la première possibilité, car même si le second permet beaucoup plus de flexibilité, la première méthode est plus simple et permet un changement postérieur si les besoins changent.

Nous allons suivre ces 4 étapes : 

1. Créer un modèle "CustomUser".
1. Mettre à jour le fichier `settings.py`.
1. Adapter `UserCreationForm` et `UserChangeForm`.
1. Ajouter le nouveau modèle à `admin.py`.

<Aside type="caution" title="Avant de continuer">
* Supprimez toute migration de votre base de données 
   ``` sh showLineNumbers=false frame="none"
   python manage.py migrate <app> zero
   ```
* et supprimez les fichiers migrations.
</Aside>

#### Configuration du modèle d'utilisateur

``` python showLineNumbers=false ins={1,5} del={4}
  from django.contrib.auth.models import AbstractUser 
  from django.db import models
  
  class Developer(models.Model):
  class Developer(AbstractUser):                      
```

Nous allons maintenant ajouter un paramètre `AUTH_USER_MODEL` au bas de notre fichier de configuration afin de demander à notre projet d'utiliser notre modèle plutôt que le modèle d'utilisateur par défaut.

``` python showLineNumbers=false title=mproject/settings.py ins={5,6}
  # CRISPY FORM CONFIGURATION
  CRISPY_ALLOWED_TEMPLATE_PACKS = "bootstrap5"
  CRISPY_TEMPLATE_PACK = 'bootstrap5'
  
  # AUTH CONFIGURATION 
  AUTH_USER_MODEL = 'developer.Developer'
```

#### Formulaire pour le modèle d'utilisateur

On ne va pas y aller par 4 chemins, ici nous allons remplacer notre formulaire, modifier la classe dont elle hérite, et ajouter un formulaire pour
permettre la modification de notre utilisateur.

``` python showLineNumbers=false title=developer/forms.py
from django.contrib.auth import get_user_model
from django.contrib.auth.forms import UserCreationForm, UserChangeForm
from django import forms
from .models import Developer

class DeveloperForm(UserCreationForm):
    class Meta:
        model = get_user_model()
        fields = ('first_name', 'last_name', 'username', 'email',)

class DeveloperChangeForm(UserChangeForm):
    class Meta:
        model = get_user_model()
        fields = ('first_name', 'last_name', 'username', 'email')

```

#### Modification Admin de l'utilisateur

Nous allons maintenant modifier le fichier `developer/admin.py` afin de modifier les formulaires de création et de modification.
Pour cela, il est nécessaire de modifier les champs `add_form` et `form` hérité de la classe `UserAdmin`.

La méthode `get_user_model` permet d'importer le modèle d'utilisateur précédemment configuré dans le fichier `settings.py`.

``` python showLineNumbers=false title=developer/admin.py ins={1,2,5,14-17,19} del={13,18}
  from django.contrib.auth import get_user_model
  from django.contrib.auth.admin import UserAdmin
  from django.contrib import admin
  
  from .forms import DeveloperForm, DeveloperChangeForm
  from .models import Developer
  from task.models import Task
  
  class TaskInline(admin.TabularInline):
      model = Task
      extra = 1
  
  class DeveloperAdmin(admin.ModelAdmin):
  class DeveloperAdmin(UserAdmin):
      add_form = DeveloperForm
      form = DeveloperChangeForm
      model = get_user_model()
      list_display = ('first_name', 'last_name', 'is_free')
      list_display = ('first_name', 'last_name', 'username', 'is_free')
      inlines = [TaskInline]
```

#### Adaptation pour la commande `createsuperuser`

Enfin, un super utilisateur est un utilisateur comme les autres. Il est donc important d'ajouter le prénom et le nom d'un super utilisateur lors de sa création (c'est-à-dire lors de l'appel à `createsuperuser`).

``` python showLineNumbers=false title=developer/models.py ins={7}
  #...

  class Developer(AbstractUser):
      first_name = models.CharField("first name", max_length=200)
      last_name = models.CharField(max_length=200)
  
      REQUIRED_FIELDS=['first_name', 'last_name'] 
  
      def is_free(self):
          return self.tasks.count() == 0

  #...
```

Faites la migration et testez la création d'un nouveau super utilisateur. Vous devriez avoir le nom et prénom qui fait dorénavant partie des données requises.

#### Correction du formulaire de création de développeur

Si vous essayez de créer un développeur, vous verrez que de nombreux champs se sont ajoutés au formulaire. Essayez ! ✏️ Ceci est tout à fait normal puisqu'un développeur est un utilisateur. Les champs `username` ; `email` ; `password`... sont ainsi demandés. Nous allons donner un autre formulaire afin de créer un développeur avec les données minimales à leur gestion.

Ajoutez un formulaire simplifié lié directement au modèle développeur.

``` python showLineNumbers=false title={developer/forms.py} ins={3,7}
  #...

  class ShortDeveloperForm(forms.ModelForm):             
     class Meta:                                         
         model = Developer                               
         fields = ['first_name', 'last_name', 'username']

  #...
```

Et enfin, n'oubliez pas que ce formulaire est traité lors de la création d'un développeur et envoyé lorsque la vue `index` des développeurs est demandée. Modifiez la vue afin que le champ `username` soit également considéré.

``` python showLineNumbers=false title=developer/views.py ins={3,15,21,27} del={2, 14,20}
  #...
  from .forms import DeveloperForm
  from .forms import ShortDeveloperForm
  
  #...
  
  class IndexView(ListView):
      model = Developer
      template_name = "developer/index.html"
      context_object_name = 'developers'
  
      def get_context_data(self, **kwargs):
          context = super(IndexView, self).get_context_data(**kwargs)
          context['form'] = DeveloperForm
          context['form'] = ShortDeveloperForm
  
  #...
  
  def create(request):
      form = DeveloperForm(request.POST)
      form = ShortDeveloperForm(request.POST)
  
      if form.is_valid():
          Developer.objects.create(
              first_name=form.cleaned_data['first_name'],
              last_name=form.cleaned_data['last_name'],
              username=form.cleaned_data['username'],
          )
  #...
```

Testez la création d'un développeur au sein de votre projet (sans passer par l'interface d'administration) et vérifiez la création de l'utilisateur dans l'interface d'administration. Si vous voulez, vous pouvez ajouter un mot de passe à ce nouveau développeur.

D'un point de vue utilisateur, votre projet fonctionne comme avant (exception faite du champ `username`). Mais grâce à nos ajouts, nous pouvons maintenant passer à la gestion de la connexion et des permissions.

<Aside title="Info">
 Dans la vue, la création d'un développeur se fait grâce à la fonction `Developer.objects.create(...)`. Si vous souhaitez créer un utilisateur avec tous les champs requis, utilisez la fonction `Developer.objects.create_user(...)`.
</Aside>